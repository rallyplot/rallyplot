name: Linux - test_plotter

on:
  pull_request:

  schedule:
    # Every Monday at 00:00 UTC â€” adjust as needed
    - cron: "0 0 * * 1"

jobs:
  test_plotter_linux:
    name: Test on ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # , windows-latest, macos-latest, macos-15-intel
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      # --- Linux-only system deps (this is the "stuff" you only want on Linux) ---
      - name: Install system dependencies (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-cursor0 \
            libxcb-keysyms1 \
            libxcb-shape0 \
            libxcb-icccm4 \
            xvfb

      - name: Install Python dependencies
        run: |
          python -m pip install -U pip
          python -m pip install -U rallyplot[dev] --pre
         
      # ---------------- Shared test env ----------------
      - name: Set test environment
        shell: bash
        run: |
          echo "PYTHONFAULTHANDLER=1" >> $GITHUB_ENV
          echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV
          echo "MPLBACKEND=Agg" >> $GITHUB_ENV

      # ---------------- Linux tests (xvfb) ----------------
      - name: Run tests on Linux (xvfb)
        if: runner.os == 'Linux'
        run: |
          xvfb-run -a python -u tests/python/test_regression.py "test"
          xvfb-run -a python -u tests/python/test_toy_data.py
          xvfb-run -a python -u tests/python/test_smoke_dataframe.py

      # ---------------- Non-Linux tests ----------------
      - name: Run tests on ${{ runner.os }} (no xvfb)
        if: runner.os != 'Linux'
        run: |
          python -u tests/python/test_regression.py "test"
          python -u tests/python/test_toy_data.py
          python -u tests/python/test_smoke_dataframe.py
